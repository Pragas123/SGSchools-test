import React, { useState, useEffect } from "react";

// Sugar Group Schools - Single-file React prototype
// - Uses Tailwind CSS classes (assumes Tailwind available in the host project)
// - Simulates email verification (console.log the code). In production, wire to an email provider.
// - Uses a mock 'preloadedUsers' dataset to simulate that you already have their data.
// - After verification an account is created (username/password), user logs in and sees prefilled profile.
// - Provides Material Request, Service Request, Leave Form, Leave Permit
// - Stores accounts and requests in localStorage for persistence across reloads.

// --------------------------- MOCK / ADMIN DATA (replace with real DB) ---------------------------
const preloadedUsers = {
  // key = email
  "andi.sari@sugargroup.sch.id": {
    name: "Andi Sari",
    employeeId: "SGS-001",
    role: "Teacher",
    campus: "Jakarta Utara",
    phone: "081234567890",
    address: "Jl. Merpati No. 10",
    birthDate: "1990-04-12",
    photo: "https://files.catbox.moe/nmqo6a.png" // using provided logo as placeholder photo
  },
  "budi.putra@sugargroup.sch.id": {
    name: "Budi Putra",
    employeeId: "SGS-002",
    role: "Admin",
    campus: "Bandung",
    phone: "081098765432",
    address: "Jl. Melati No. 3",
    birthDate: "1985-09-02",
    photo: "https://files.catbox.moe/nmqo6a.png"
  }
};

// Utility: localStorage helpers
const LS = {
  get(key, fallback) {
    try {
      const v = JSON.parse(localStorage.getItem(key));
      return v === null ? fallback : v;
    } catch (e) {
      return fallback;
    }
  },
  set(key, val) {
    localStorage.setItem(key, JSON.stringify(val));
  }
};

// Keep verification codes in memory (simulation). In production you'd store temporarily in server.
const verificationStore = {};

// --------------------------- App ---------------------------
export default function App() {
  const [route, setRoute] = useState("auth"); // auth, login, home
  const [message, setMessage] = useState(null);
  const [currentUser, setCurrentUser] = useState(LS.get("sgs_currentUser", null));

  useEffect(() => {
    if (currentUser) {
      setRoute("home");
      LS.set("sgs_currentUser", currentUser);
    } else {
      setRoute("auth");
    }
  }, []);

  useEffect(() => {
    LS.set("sgs_users", LS.get("sgs_users", {}));
  }, []);

  function logout() {
    setCurrentUser(null);
    LS.set("sgs_currentUser", null);
    setRoute("login");
  }

  return (
    <div className="min-h-screen bg-slate-50 p-6">
      <div className="max-w-4xl mx-auto">
        <Header user={currentUser} onLogout={logout} />

        {route === "auth" && (
          <div className="mt-8">
            <EmailVerification
              onVerified={(account) => {
                setCurrentUser(account);
                setMessage({ type: "success", text: "Akun berhasil dibuat — Anda sudah login." });
                setRoute("home");
              }}
            />
            <div className="mt-6 text-sm text-slate-500">Sudah punya akun? <button className="text-blue-600 underline" onClick={() => setRoute("login")}>Login di sini</button></div>
          </div>
        )}

        {route === "login" && (
          <div className="mt-8">
            <Login onLogin={(acc) => { setCurrentUser(acc); setRoute("home"); }} onBack={() => setRoute("auth")} />
          </div>
        )}

        {route === "home" && currentUser && (
          <div className="mt-6">
            <Home user={currentUser} updateUser={(u) => { setCurrentUser(u); }} />
          </div>
        )}

        {message && (
          <div className={`mt-4 p-3 rounded ${message.type === "success" ? "bg-green-50 text-green-800" : "bg-red-50 text-red-800"}`}>{message.text}</div>
        )}

        <div className="mt-10 text-xs text-slate-400">Prototype: untuk produksi hubungkan backend & provider email. (Simulasi kode verifikasi dicetak di console.)</div>
      </div>
    </div>
  );
}

// --------------------------- Header ---------------------------
function Header({ user, onLogout }) {
  return (
    <div className="flex items-center justify-between bg-white p-4 rounded-lg shadow-sm">
      <div className="flex items-center gap-3">
        <img src="https://files.catbox.moe/nmqo6a.png" alt="logo" className="w-12 h-12 rounded" />
        <div>
          <div className="text-lg font-semibold">Sugar Group Schools</div>
          <div className="text-sm text-slate-500">Employee self-service prototype</div>
        </div>
      </div>
      <div>
        {user ? (
          <div className="flex items-center gap-3">
            <div className="text-sm text-slate-600">{user.name}</div>
            <button className="px-3 py-1 bg-red-50 text-red-700 rounded" onClick={onLogout}>Logout</button>
          </div>
        ) : (
          <div className="text-sm text-slate-500">Welcome — please verify your email to create account</div>
        )}
      </div>
    </div>
  );
}

// --------------------------- Email Verification Flow ---------------------------
function EmailVerification({ onVerified }) {
  const [step, setStep] = useState(1); // 1 = enter email, 2 = enter code, 3 = set credentials
  const [email, setEmail] = useState("");
  const [codeInput, setCodeInput] = useState("");
  const [accountName, setAccountName] = useState("");

  function sendCode() {
    const normalized = email.trim().toLowerCase();
    if (!normalized) return alert("Masukkan email yang valid.");

    // Check if this email exists in preloadedUsers — represents admin data
    if (!preloadedUsers[normalized]) {
      if (!confirm("Email tidak ditemukan di data. Anda ingin tetap melanjutkan pendaftaran manual?")) return;
      // allow manual creation
    }

    // create 6-digit code
    const code = Math.floor(100000 + Math.random() * 900000).toString();
    verificationStore[normalized] = code;

    // Simulate sending email — in production, send via email provider
    console.log(`SIMULATED EMAIL to ${normalized}: verif code = ${code}`);
    alert("Kode verifikasi telah dikirim (simulasi). Periksa console (dev). Untuk produksi hubungkan ke SMTP/SendGrid/Mailgun/dll.");
    setStep(2);
  }

  function verifyCode() {
    const normalized = email.trim().toLowerCase();
    if (verificationStore[normalized] && verificationStore[normalized] === codeInput.trim()) {
      // move to credentials. Pre-populate name if we have preloaded data
      const preload = preloadedUsers[normalized];
      setAccountName(preload ? preload.name : "");
      setStep(3);
    } else {
      alert("Kode verifikasi salah. Cek kembali.");
    }
  }

  function createAccount(password) {
    const normalized = email.trim().toLowerCase();

    // create username automatically from email prefix if not exists
    const username = normalized.split("@")[0];

    const users = LS.get("sgs_users", {});
    // If preloaded profile exists, attach it; otherwise create a minimal profile
    const profile = preloadedUsers[normalized] || {
      name: accountName || username,
      employeeId: `TMP-${Math.floor(1000 + Math.random() * 9000)}`,
      role: "Staff",
      campus: "Unknown",
      phone: "",
      address: "",
      birthDate: "",
      photo: "https://files.catbox.moe/nmqo6a.png"
    };

    const account = { username, email: normalized, password, ...profile };
    users[username] = account;
    LS.set("sgs_users", users);

    // cleanup verification
    delete verificationStore[normalized];

    // log them in
    LS.set("sgs_currentUser", account);
    onVerified(account);
  }

  return (
    <div className="bg-white p-6 rounded shadow">
      <h2 className="text-xl font-semibold mb-3">Verifikasi Email</h2>
      {step === 1 && (
        <div className="space-y-3">
          <p className="text-sm text-slate-600">Masukkan email institusi Anda untuk menerima kode verifikasi. Sistem akan membuat username otomatis dan meminta Anda membuat password.</p>
          <input className="w-full p-2 border rounded" placeholder="email@domain" value={email} onChange={(e) => setEmail(e.target.value)} />
          <div className="flex gap-2">
            <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={sendCode}>Kirim kode</button>
          </div>
        </div>
      )}

      {step === 2 && (
        <div className="space-y-3">
          <p className="text-sm">Masukkan 6 digit kode verifikasi yang dikirim ke email Anda.</p>
          <input className="w-40 p-2 border rounded" value={codeInput} onChange={(e) => setCodeInput(e.target.value)} />
          <div className="flex gap-2">
            <button className="px-4 py-2 bg-green-600 text-white rounded" onClick={verifyCode}>Verifikasi</button>
            <button className="px-4 py-2 bg-slate-100 rounded" onClick={() => setStep(1)}>Kembali</button>
          </div>
        </div>
      )}

      {step === 3 && (
        <div className="space-y-3">
          <p className="text-sm">Akun Anda hampir selesai. Username otomatis dibuat dari email; masukkan password.</p>
          <div>
            <label className="text-sm block">Nama (bisa diedit)</label>
            <input className="w-full p-2 border rounded" value={accountName} onChange={(e) => setAccountName(e.target.value)} />
          </div>
          <PasswordForm onCreate={createAccount} />
        </div>
      )}
    </div>
  );
}

function PasswordForm({ onCreate }) {
  const [pw, setPw] = useState("");
  const [pw2, setPw2] = useState("");

  function submit() {
    if (!pw || pw.length < 6) return alert("Password minimal 6 karakter.");
    if (pw !== pw2) return alert("Password tidak sama.");
    onCreate(pw);
  }

  return (
    <div className="space-y-2">
      <input placeholder="Password" type="password" className="w-full p-2 border rounded" value={pw} onChange={(e) => setPw(e.target.value)} />
      <input placeholder="Ulangi Password" type="password" className="w-full p-2 border rounded" value={pw2} onChange={(e) => setPw2(e.target.value)} />
      <div className="flex gap-2">
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={submit}>Buat Akun & Login</button>
      </div>
    </div>
  );
}

// --------------------------- Login ---------------------------
function Login({ onLogin, onBack }) {
  const [username, setUsername] = useState("");
  const [password, setPassword] = useState("");

  function attempt() {
    const users = LS.get("sgs_users", {});
    if (users[username] && users[username].password === password) {
      LS.set("sgs_currentUser", users[username]);
      onLogin(users[username]);
    } else {
      alert("Username atau password salah.");
    }
  }

  return (
    <div className="bg-white p-6 rounded shadow">
      <h3 className="text-lg font-semibold mb-3">Login</h3>
      <input className="w-full p-2 border rounded mb-2" placeholder="username" value={username} onChange={(e) => setUsername(e.target.value)} />
      <input className="w-full p-2 border rounded mb-2" placeholder="password" type="password" value={password} onChange={(e) => setPassword(e.target.value)} />
      <div className="flex gap-2">
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={attempt}>Login</button>
        <button className="px-4 py-2 bg-slate-100 rounded" onClick={onBack}>Kembali</button>
      </div>
    </div>
  );
}

// --------------------------- Home & Dashboard ---------------------------
function Home({ user, updateUser }) {
  const [tab, setTab] = useState("profile");

  return (
    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div className="md:col-span-1 bg-white p-4 rounded shadow">
        <ProfileCard user={user} onUpdate={(u) => { updateUser(u); const users = LS.get("sgs_users", {}); users[u.username] = u; LS.set("sgs_users", users); LS.set("sgs_currentUser", u); }} />
        <nav className="mt-4 space-y-2">
          <button className={`w-full text-left p-2 rounded ${tab === "profile" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("profile")}>Profile</button>
          <button className={`w-full text-left p-2 rounded ${tab === "material" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("material")}>Material Request</button>
          <button className={`w-full text-left p-2 rounded ${tab === "service" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("service")}>Service Request</button>
          <button className={`w-full text-left p-2 rounded ${tab === "leave" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("leave")}>Form Cuti</button>
          <button className={`w-full text-left p-2 rounded ${tab === "permit" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("permit")}>Leave Permit</button>
          <button className={`w-full text-left p-2 rounded ${tab === "requests" ? "bg-blue-50" : "bg-slate-50"}`} onClick={() => setTab("requests")}>My Requests</button>
        </nav>
      </div>

      <div className="md:col-span-2 bg-white p-4 rounded shadow">
        {tab === "profile" && <ProfileEditor user={user} onSave={(u) => updateUser(u)} />}
        {tab === "material" && <MaterialRequestForm user={user} />}
        {tab === "service" && <ServiceRequestForm user={user} />}
        {tab === "leave" && <LeaveForm user={user} type="cuti" />}
        {tab === "permit" && <LeaveForm user={user} type="permit" />}
        {tab === "requests" && <RequestsList user={user} />}
      </div>
    </div>
  );
}

function ProfileCard({ user, onUpdate }) {
  return (
    <div className="flex items-center gap-3">
      <img src={user.photo || "https://files.catbox.moe/nmqo6a.png"} alt="foto" className="w-20 h-20 rounded" />
      <div>
        <div className="font-semibold">{user.name}</div>
        <div className="text-sm text-slate-600">{user.role} — {user.campus}</div>
        <div className="mt-2 text-xs text-slate-500">ID: {user.employeeId}</div>
      </div>
    </div>
  );
}

function ProfileEditor({ user, onSave }) {
  const [form, setForm] = useState({ ...user });
  function save() {
    onSave(form);
    alert("Profil disimpan.");
  }
  return (
    <div>
      <h3 className="text-lg font-semibold mb-3">Data Diri</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
        <input className="p-2 border rounded" value={form.name} onChange={(e) => setForm({ ...form, name: e.target.value })} />
        <input className="p-2 border rounded" value={form.employeeId} onChange={(e) => setForm({ ...form, employeeId: e.target.value })} />
        <input className="p-2 border rounded" value={form.role} onChange={(e) => setForm({ ...form, role: e.target.value })} />
        <input className="p-2 border rounded" value={form.campus} onChange={(e) => setForm({ ...form, campus: e.target.value })} />
        <input className="p-2 border rounded" value={form.phone} onChange={(e) => setForm({ ...form, phone: e.target.value })} />
        <input className="p-2 border rounded" value={form.birthDate} onChange={(e) => setForm({ ...form, birthDate: e.target.value })} />
        <input className="p-2 border rounded md:col-span-2" value={form.address} onChange={(e) => setForm({ ...form, address: e.target.value })} />
      </div>
      <div className="mt-4">
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={save}>Simpan Data</button>
      </div>
    </div>
  );
}

// --------------------------- Requests & Forms ---------------------------
function newRequestBase(user, category) {
  return {
    id: `REQ-${Date.now()}-${Math.floor(Math.random() * 900)}`,
    createdAt: new Date().toISOString(),
    username: user.username,
    name: user.name,
    category,
    status: "submitted",
    notes: ""
  };
}

function MaterialRequestForm({ user }) {
  const [items, setItems] = useState([{ name: "", quantity: 1 }]);

  function addItem() { setItems([...items, { name: "", quantity: 1 }]); }
  function updateItem(i, field, value) { const c = [...items]; c[i][field] = value; setItems(c); }

  function submit() {
    const req = newRequestBase(user, "material");
    req.items = items.filter(it => it.name.trim());
    if (!req.items.length) return alert("Tambahkan minimal 1 item.");
    const all = LS.get("sgs_requests", []);
    all.push(req);
    LS.set("sgs_requests", all);
    alert("Material request terkirim.");
    setItems([{ name: "", quantity: 1 }]);
  }

  return (
    <div>
      <h3 className="text-lg font-semibold mb-3">Material Request</h3>
      <div className="space-y-2">
        {items.map((it, idx) => (
          <div key={idx} className="flex gap-2">
            <input className="flex-1 p-2 border rounded" placeholder="Nama barang" value={it.name} onChange={(e) => updateItem(idx, "name", e.target.value)} />
            <input className="w-24 p-2 border rounded" type="number" value={it.quantity} onChange={(e) => updateItem(idx, "quantity", e.target.value)} />
          </div>
        ))}
        <div className="flex gap-2">
          <button className="px-3 py-2 bg-slate-100 rounded" onClick={addItem}>Tambah Item</button>
          <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={submit}>Kirim Request</button>
        </div>
      </div>
    </div>
  );
}

function ServiceRequestForm({ user }) {
  const [subject, setSubject] = useState("");
  const [desc, setDesc] = useState("");

  function submit() {
    if (!subject.trim()) return alert("Masukkan judul service.");
    const req = newRequestBase(user, "service");
    req.subject = subject;
    req.description = desc;
    const all = LS.get("sgs_requests", []);
    all.push(req);
    LS.set("sgs_requests", all);
    alert("Service request terkirim.");
    setSubject(""); setDesc("");
  }

  return (
    <div>
      <h3 className="text-lg font-semibold mb-3">Service Request</h3>
      <input className="w-full p-2 border rounded mb-2" placeholder="Judul" value={subject} onChange={(e) => setSubject(e.target.value)} />
      <textarea className="w-full p-2 border rounded mb-2" placeholder="Deskripsi singkat" value={desc} onChange={(e) => setDesc(e.target.value)} />
      <div>
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={submit}>Kirim</button>
      </div>
    </div>
  );
}

function LeaveForm({ user, type }) {
  const [start, setStart] = useState("");
  const [end, setEnd] = useState("");
  const [reason, setReason] = useState("");

  function submit() {
    if (!start || !end) return alert("Pilih tanggal mulai dan akhir.");
    const req = newRequestBase(user, type === "cuti" ? "leave" : "permit");
    req.period = { start, end };
    req.reason = reason;
    const all = LS.get("sgs_requests", []);
    all.push(req);
    LS.set("sgs_requests", all);
    alert(`${type === "cuti" ? "Form cuti" : "Leave permit"} terkirim.`);
    setStart(""); setEnd(""); setReason("");
  }

  return (
    <div>
      <h3 className="text-lg font-semibold mb-3">{type === "cuti" ? "Form Cuti" : "Leave Permit"}</h3>
      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
        <label className="text-sm">Dari</label>
        <label className="text-sm">Sampai</label>
        <input type="date" className="p-2 border rounded" value={start} onChange={(e) => setStart(e.target.value)} />
        <input type="date" className="p-2 border rounded" value={end} onChange={(e) => setEnd(e.target.value)} />
      </div>
      <textarea className="w-full p-2 border rounded my-2" placeholder="Alasan" value={reason} onChange={(e) => setReason(e.target.value)} />
      <div>
        <button className="px-4 py-2 bg-blue-600 text-white rounded" onClick={submit}>Kirim</button>
      </div>
    </div>
  );
}

function RequestsList({ user }) {
  const [list, setList] = useState(LS.get("sgs_requests", []));

  useEffect(() => {
    setList(LS.get("sgs_requests", []));
  }, []);

  return (
    <div>
      <h3 className="text-lg font-semibold mb-3">Permintaan Saya</h3>
      {list.filter(r => r.username === user.username).length === 0 && <div className="text-sm text-slate-500">Belum ada request.</div>}
      <div className="space-y-3">
        {list.filter(r => r.username === user.username).map(r => (
          <div key={r.id} className="p-3 border rounded">
            <div className="flex justify-between items-start">
              <div>
                <div className="font-semibold">{r.category.toUpperCase()} — {r.id}</div>
                <div className="text-xs text-slate-500">Dibuat: {new Date(r.createdAt).toLocaleString()}</div>
              </div>
              <div className={`px-2 py-1 rounded text-xs ${r.status === 'submitted' ? 'bg-yellow-50 text-yellow-700' : 'bg-green-50 text-green-700'}`}>{r.status}</div>
            </div>
            <div className="mt-2 text-sm text-slate-700">
              {r.subject && <div><strong>{r.subject}</strong></div>}
              {r.items && <div className="mt-2">Items: {r.items.map(it => `${it.name} (x${it.quantity})`).join(", ")}</div>}
              {r.reason && <div className="mt-2">Reason: {r.reason}</div>}
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

// --------------------------------------------------------------------------------
// Notes for production integration (leave in comments):
// - Replace simulated verification with backend API that generates code and sends via SMTP/SendGrid/Mailgun.
// - Use secure password storage (bcrypt) and proper auth tokens (JWT + refresh tokens or sessions).
// - Store users and requests in a database (Postgres, MySQL, MongoDB).
// - Add role-based access control for approvals, admin dashboards, and notifications.
// - Add file upload for attachments on requests (policy documents, doctor's note, etc.).
// - Add email/sms notifications for status changes.
// - Add server-side validation and rate limiting to avoid abuse.
// --------------------------------------------------------------------------------
